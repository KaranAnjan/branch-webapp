<!DOCTYPE html>
<html>
<head>
  <title>Branch Data Web App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      line-height: 1.6;
    }
    h2, h3 {
      text-align: center;
    }
    .tabs {
      text-align: center;
      margin-bottom: 20px;
    }
    .tabs button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
      border: none;
      cursor: pointer;
    }
    .tabs button.active {
      background-color: #00A651;
      color: white;
    }
    .tabs button:not(.active) {
      background-color: #eee;
      color: #333;
    }
    .tab {
      display: none;
    }
    .tab.active {
      display: block;
    }
    form {
      max-width: 400px;
      margin: 0 auto;
    }
    form input, form select {
      width: 100%;
      padding: 8px;
      margin: 5px 0 15px;
      font-size: 16px;
    }
    label {
      font-weight: bold;
    }
    select {
      font-size: 16px;
    }
	form h4 {
  margin-top: 20px;
  margin-bottom: 10px;
  color: #22265C;
  border-bottom: 2px solid #00A651;
  padding-bottom: 5px;
}

.submit-btn {
  background-color: #00A651;
  color: white;
  font-size: 18px;
  padding: 12px 20px;
  border: none;
  border-radius: 5px;
  width: 100%;
  cursor: pointer;
}

.submit-btn:hover {
  background-color: #008f46;
}
.chart-subtitle {
  text-align: center;
  margin: 5px 0 15px 0;
  font-weight: 600;
  font-size: 16px;
}

#kpi_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin-bottom: 20px;
}

.kpi_card {
  background: #00A651;
  color: white;
  padding: 10px 15px;  /* âœ… less vertical padding */
  border-radius: 8px;
  text-align: center;
  flex: 1 1 120px;     /* âœ… allow flexible width, smaller min width */
  max-width: 200px;
  display: flex;       /* âœ… use flex to center text vertically */
  flex-direction: column;
  justify-content: center;
}

.kpi_card h4 {
  margin: 0;
  font-size: 14px;
  font-weight: normal;
}

.kpi_card h2 {
  margin: 5px 0 0;
  font-size: 20px;
}

@media (max-width: 600px) {
  .kpi_card {
    flex: 1 1 100px;   /* âœ… smaller cards on mobile */
    padding: 8px 10px;
  }
  .kpi_card h2 {
    font-size: 18px;
  }
  .kpi_card h4 {
    font-size: 12px;
  }
}




  </style>
</head>
<body>

<h2 style="display: flex; align-items: center; justify-content: center;">
  <img src="https://raw.githubusercontent.com/KaranAnjan/logo/main/primeeast_logo.png" alt="Logo" style="height: 40px; margin-right: 10px;">
  Branch Data Web App
</h2>




  <div class="tabs">
    <button id="entryBtn" onclick="showTab('entry')">Data Entry</button>
    <button id="dashboardBtn" onclick="showTab('dashboard')">Dashboard</button>
  </div>

  <!-- DATA ENTRY TAB -->
  <div id="entry" class="tab">
    <h3>Data Entry</h3>
<form id="branchForm">
  <label>Branch Name:</label>
  <select name="branchName" required>
    <option value="">--Select Branch--</option>
    <option>Baghajatin</option>
    <option>Behala</option>
    <option>Dunlop</option>
    <option>Park Circus</option>
    <option>Rajarhat</option>
    <option>Taratala</option>
  </select>

  <h4>ðŸ“¦ Delivery Details</h4>
  <label>Retail Count:</label>
  <input type="number" name="retail">
  <label>Retail Value:</label>
  <input type="number" name="retailValue">
  <label>WS Count:</label>
  <input type="number" name="ws">
  <label>WS Value:</label>
  <input type="number" name="wsValue">

  <h4>ðŸ•‘ Pending Details</h4>
  <label>Retail Hold Count:</label>
  <input type="number" name="retailHold">
  <label>Retail Hold Value:</label>
  <input type="number" name="retailHoldValue">
  <label>WS Hold Count:</label>
  <input type="number" name="wsHold">
  <label>WS Hold Value:</label>
  <input type="number" name="wsHoldValue">

  <h4>ðŸ‘¥ Attendance</h4>
  <label>Attendance DB:</label>
  <input type="number" name="attendanceDB">
  <label>Attendance GH:</label>
  <input type="number" name="attendanceGH">
  <label>Attendance DLO:</label>
  <input type="number" name="attendanceDLO">

  <h4>ðŸšš Vehicle</h4>
  <label>Vehicle Use:</label>
  <input type="number" name="vehicleUse">
  <label>Van Use:</label>
  <input type="number" name="vanUse">
  
  <label for="vehicleOutTime">First Vehicle Out Time:</label><br>
  <input type="time" id="vehicleOutTime" name="vehicleOutTime" required>

  <button type="submit" class="submit-btn">Submit</button>
</form>	
  </div>

  <!-- DASHBOARD TAB -->
  <div id="dashboard" class="tab">
    <h3>Dashboard</h3>

    <div id="delivery_chart" style="width: 100%; height: 300px;"></div>
    <div id="hold_chart" style="width: 100%; height: 300px;"></div>

<h4>Pending Delivery Details</h4>
<div id="hold_table" style="width: 100%;"></div>



<!-- Attendance section -->
<h4>
  Attendance:
  <select id="attendanceSelector" onchange="drawAttendanceChart()">
    <option value="ALL">ALL</option>
    <option value="DB">DB</option>
    <option value="GH">GH</option>
    <option value="DLO">DLO</option>
  </select>
</h4>
<h5 id="attendance_chart_title" class="chart-subtitle">Attendance</h5>
<div id="attendance_chart" style="width: 100%; height: 300px;"></div>


<!-- Vehicle section -->
<h4>
  Vehicle:
  <select id="vehicleSelector" onchange="drawVehicleChart()">
    <option value="ALL">ALL</option>
    <option value="Vehicle Use">Vehicle Use</option>
    <option value="Van Use">Van Use</option>
  </select>
</h4>
<h5 id="vehicle_chart_title" class="chart-subtitle">Vehicle</h5>
<div id="vehicle_chart" style="width: 100%; height: 300px;"></div>

<div id="kpi_container" style="display: flex; justify-content: space-around; margin-bottom: 20px;">
  <div class="kpi_card" id="kpi_today_sale"></div>
  <div class="kpi_card" id="kpi_month_sale"></div>
  <div class="kpi_card" id="kpi_outstanding"></div>
</div>


<h4>Today Sale</h4>
<div id="today_sales_chart" style="width: 100%; height: 400px;"></div>

<h4>Month Sale</h4>
<div id="month_sales_chart" style="width: 100%; height: 400px;"></div>


<script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbywerkpXiGd46-0c6Dm0N-Fq_mDH8gWr_OSqYObQ0nn3Dyxfh8vocf5zLWlFSOxjATv8A/exec'; // Replace with your Apps Script URL

  function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');

    // Update active button styles
    document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
    if (tabName === 'entry') {
      document.getElementById('entryBtn').classList.add('active');
    } else {
      document.getElementById('dashboardBtn').classList.add('active');
    }

    // If dashboard, draw charts
    if (tabName === 'dashboard') {
      drawCharts();
    }
  }

  // Handle form submit
  const form = document.getElementById('branchForm');
  form.addEventListener('submit', e => {
    e.preventDefault();
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => { data[key] = value; });

    fetch(scriptURL, {
      method: 'POST',
      body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(res => {
      alert('Data submitted successfully!');
      form.reset();
    })
    .catch(err => {
      alert('Error submitting data');
      console.error(err);
    });
  });

  // Load Google Charts
 google.charts.load('current', {
  packages: ['corechart', 'table']  // âœ… added 'table'
});

 let globalData = [];
let globalReportData = [];


 function drawCharts() {
  fetch(scriptURL)
    .then(res => res.json())
    .then(allData => {
      globalData = allData.sheet1;           // âœ… live form entries
      globalReportData = allData.reportstable; // âœ… your fixed sales table

      // âœ… Now call all charts:
      drawDeliveryChart();
      drawHoldChart();
	  drawHoldTable();
      drawAttendanceChart();
      drawVehicleChart();
	  drawKPIs();
      drawTodaySalesChart();   // âœ… youâ€™ll add this
      drawMonthSalesChart();   // âœ… youâ€™ll add this
    })
    .catch(err => console.error('Error fetching data:', err));
}


function drawDeliveryChart() {
  const chartData = [
    ['Branch', 'Retail Value', 'WS Value', { role: 'annotation' }]
  ];

  globalData.forEach(row => {
    const retailRaw = Number(row['Retail Value']) || 0;
    const wsRaw = Number(row['WS Value']) || 0;

    const retail = +(retailRaw / 100000).toFixed(2);
    const ws = +(wsRaw / 100000).toFixed(2);
    const total = +(retail + ws).toFixed(2);

    chartData.push([row['Branch Name'], retail, ws, total]);
  });

  const dataTable = google.visualization.arrayToDataTable(chartData);

  // âœ… Calculate max total for tight X-axis
  const totals = chartData.slice(1).map(row => row[1] + row[2]); // Retail + WS
  const maxTotal = Math.max(...totals);

  const options = { 
    title: 'Delivery: Retail + WS Total (in Lakh)',
    legend: { position: 'top' },
    chartArea: { 
      left: 60,
      right: 20,
      width: '100%'
    },
    colors: ['#00A651', '#22265C'],
    isStacked: true,
    annotations: {
      alwaysOutside: true,
      textStyle: {
        fontSize: 12,
        color: '#000',
        auraColor: 'none'
      }
    },
    hAxis: {
      viewWindow: {
        max: maxTotal * 1.1  // âœ… Add 10% headroom for nice look
      },
      title: 'Value (Lakh)',
      textPosition: 'out',
      gridlines: { count: 0 }
    },
    vAxis: {
      textPosition: 'out',
      gridlines: { color: 'transparent' }
    }
  };

  const chart = new google.visualization.BarChart(document.getElementById('delivery_chart'));
  chart.draw(dataTable, options);
}


function drawHoldChart() {
  const chartData = [
    ['Branch', 'Retail Hold Value', 'WS Hold Value', { role: 'annotation' }]
  ];

  globalData.forEach(row => {
    const retailHold = Number(row['Retail Hold Value']) || 0;
    const wsHold = Number(row['WS Hold Value']) || 0;

    const retail = +(retailHold / 100000).toFixed(2);
    const ws = +(wsHold / 100000).toFixed(2);
    const total = +(retail + ws).toFixed(2);

    chartData.push([row['Branch Name'], retail, ws, total]);
  });

  const dataTable = google.visualization.arrayToDataTable(chartData);

  // âœ… Calculate max total for tight X-axis scaling
  const totals = chartData.slice(1).map(row => row[1] + row[2]); // Retail Hold + WS Hold
  const maxTotal = Math.max(...totals);

  const options = { 
    title: 'Hold Delivery: Retail Hold + WS Hold (in Lakh)',
    legend: { position: 'top' },
    chartArea: { 
      left: 60,   // âœ… same left margin as Delivery chart
      right: 20,  // âœ… same right margin
      width: '100%'
    },
    colors: ['#00A651', '#22265C'],
    isStacked: true,
    annotations: {
      alwaysOutside: true,
      textStyle: {
        fontSize: 12,
        color: '#000',
        auraColor: 'none'
      }
    },
    hAxis: {
      viewWindow: {
        max: maxTotal * 1.1 // âœ… add 10% headroom
      },
      title: 'Value (Lakh)',
      textPosition: 'out',
      gridlines: { count: 0 }
    },
    vAxis: {
      textPosition: 'out',
      gridlines: { color: 'transparent' }
    }
  };

  const chart = new google.visualization.BarChart(document.getElementById('hold_chart'));
  chart.draw(dataTable, options);
}

function drawHoldTable() {
  // âœ… 1) Build table columns: add Total Hold Count & Total Hold Value
  const chartData = [
    [
      'Branch',
      'Retail Hold Count',
      'Retail Hold Value (Lakh)',
      'WS Hold Count',
      'WS Hold Value (Lakh)',
      'Total Hold Count',
      'Total Hold Value (Lakh)'
    ]
  ];

  // âœ… 2) Prepare totals
  let totalRetailHoldCount = 0;
  let totalRetailHoldValue = 0;
  let totalWSHoldCount = 0;
  let totalWSHoldValue = 0;

  globalData.forEach(row => {
    const retailHoldCount = Number(row['Retail Hold Count']) || 0;
    const retailHoldValueRaw = Number(row['Retail Hold Value']) || 0;
    const wsHoldCount = Number(row['WS Hold Count']) || 0;
    const wsHoldValueRaw = Number(row['WS Hold Value']) || 0;

    const totalHoldCount = retailHoldCount + wsHoldCount;
    const totalHoldValueRaw = retailHoldValueRaw + wsHoldValueRaw;

    // Add to totals
    totalRetailHoldCount += retailHoldCount;
    totalRetailHoldValue += retailHoldValueRaw;
    totalWSHoldCount += wsHoldCount;
    totalWSHoldValue += wsHoldValueRaw;

    chartData.push([
      row['Branch Name'],
      retailHoldCount,
      +(retailHoldValueRaw / 100000).toFixed(2),
      wsHoldCount,
      +(wsHoldValueRaw / 100000).toFixed(2),
      totalHoldCount,
      +(totalHoldValueRaw / 100000).toFixed(2)
    ]);
  });

  // âœ… 3) Add final TOTAL row with sums (raw counts, values divided)
  const grandTotalHoldCount = totalRetailHoldCount + totalWSHoldCount;
  const grandTotalHoldValue = totalRetailHoldValue + totalWSHoldValue;

  chartData.push([
    'TOTAL',
    totalRetailHoldCount,
    +(totalRetailHoldValue / 100000).toFixed(2),
    totalWSHoldCount,
    +(totalWSHoldValue / 100000).toFixed(2),
    grandTotalHoldCount,
    +(grandTotalHoldValue / 100000).toFixed(2)
  ]);

  // âœ… 4) Draw the table
  const dataTable = google.visualization.arrayToDataTable(chartData);

  const options = {
    showRowNumber: false,
    allowHtml: true,
    width: '100%'
  };

  const chart = new google.visualization.Table(document.getElementById('hold_table'));
  chart.draw(dataTable, options);

  // âœ… 5) Style header, cells & TOTAL row
  const tableElement = document.getElementById('hold_table').getElementsByTagName('table')[0];
  if (tableElement) {
    // Header
    const headerCells = tableElement.getElementsByTagName('thead')[0].rows[0].cells;
    for (let i = 0; i < headerCells.length; i++) {
      headerCells[i].style.whiteSpace = 'normal';
      headerCells[i].style.wordWrap = 'break-word';
      headerCells[i].style.maxWidth = '100px';
      headerCells[i].style.background = '#00A651';
      headerCells[i].style.color = 'white';
      headerCells[i].style.padding = '8px';
    }

    // Body
    const bodyRows = tableElement.getElementsByTagName('tbody')[0].rows;
    for (let r = 0; r < bodyRows.length; r++) {
      const cells = bodyRows[r].cells;
      for (let c = 0; c < cells.length; c++) {
        cells[c].style.whiteSpace = 'normal';
        cells[c].style.wordWrap = 'break-word';
        cells[c].style.maxWidth = '100px';
        cells[c].style.padding = '8px';
      }
    }

    // TOTAL row
    const totalRow = bodyRows[bodyRows.length - 1];
    totalRow.style.backgroundColor = '#00A651';
    totalRow.style.color = 'white';
    totalRow.style.fontWeight = 'bold';
  }
}




function drawAttendanceChart() {
  const type = document.getElementById('attendanceSelector').value;

  // âœ… Update chart title
  const chartTitle = document.getElementById('attendance_chart_title');
  chartTitle.innerText = type === 'ALL' ? 'Attendance' : `Attendance ${type}`;

  // âœ… Build data
  const chartData = [['Branch', 'Attendance', { role: 'annotation' }]];
  globalData.forEach(row => {
    let value = 0;
    if (type === 'ALL') {
      value = Number(row['Attendance DB']) + Number(row['Attendance GH']) + Number(row['Attendance DLO']);
    } else {
      value = Number(row[`Attendance ${type}`]);
    }
    chartData.push([row['Branch Name'], value, value]); // âœ… add annotation column
  });

  const dataTable = google.visualization.arrayToDataTable(chartData);

  const options = {
    legend: 'none',
    chartArea: { width: '60%' },
    colors: ['#00A651'],
    annotations: {
      alwaysOutside: true,
      textStyle: {
        fontSize: 12,
        color: '#000',
        auraColor: 'none'
      }
    },
    hAxis: {
      title: '',
      textPosition: 'out',
      gridlines: { count: 0 } // âœ… remove grid
    },
    vAxis: {
      title: '',
      textPosition: 'out',
      gridlines: { color: 'transparent' } // âœ… remove grid
    }
  };

  const chart = new google.visualization.ColumnChart(document.getElementById('attendance_chart'));
  chart.draw(dataTable, options);
}


function drawVehicleChart() {
  const type = document.getElementById('vehicleSelector').value;

  // âœ… Update chart title
  const chartTitle = document.getElementById('vehicle_chart_title');
  chartTitle.innerText = type === 'ALL' ? 'Vehicle' : `Vehicle ${type}`;

  // âœ… Build data with annotations
  const chartData = [['Branch', 'Vehicle', { role: 'annotation' }]];
  globalData.forEach(row => {
    let value = 0;
    if (type === 'ALL') {
      value = Number(row['Vehicle Use']) + Number(row['Van Use']);
    } else {
      value = Number(row[type]);
    }
    chartData.push([row['Branch Name'], value, value]); // âœ… Add annotation
  });

  const dataTable = google.visualization.arrayToDataTable(chartData);

  const options = {
    legend: 'none',
    chartArea: { width: '60%' },
    colors: ['#22265C'],
    annotations: {
      alwaysOutside: true,  // âœ… show on top
      textStyle: {
        fontSize: 12,
        color: '#000',
        auraColor: 'none'
      }
    },
    hAxis: {
      title: '',
      textPosition: 'out',
      gridlines: { count: 0 } // âœ… remove grid
    },
    vAxis: {
      title: '',
      textPosition: 'out',
      gridlines: { color: 'transparent' } // âœ… remove grid
    }
  };

  const chart = new google.visualization.ColumnChart(document.getElementById('vehicle_chart'));
  chart.draw(dataTable, options);
}

function drawKPIs() {
  let totalToday = 0;
  let totalMonth = 0;
  let totalOutstanding = 0;

  globalReportData.forEach(row => {
    totalToday += Number(row['Today Sale']) || 0;
    totalMonth += Number(row['Month sale']) || 0;
    totalOutstanding += Number(row['Total AR']) || 0; // if you have it
  });

  // format in lakh if needed
  document.getElementById('kpi_today_sale').innerHTML = `
    <h4>Today Sale</h4>
    <h2>â‚¹ ${ (totalToday).toFixed(2) } L</h2>
  `;
  document.getElementById('kpi_month_sale').innerHTML = `
    <h4>Month Sale</h4>
    <h2>â‚¹ ${ (totalMonth).toFixed(2) } L</h2>
  `;
  document.getElementById('kpi_outstanding').innerHTML = `
    <h4>Outstanding</h4>
    <h2>â‚¹ ${ (totalOutstanding).toFixed(2) } L</h2>
  `;
}

function drawTodaySalesChart() {
  // âœ… Build data table: Branch | Retail | WS | Annotation (total)
  const chartData = [
    ['Branch', 'Retail', 'WS', { role: 'annotation' }]
  ];

  globalReportData.forEach(row => {
    const branch = row['Branch'];
    const retail = Number(row['Retail']) || 0;
    const ws = Number(row['WS']) || 0;
    const total = retail + ws;
    chartData.push([branch, retail, ws, total]);
  });

  const dataTable = google.visualization.arrayToDataTable(chartData);

  // âœ… Compute max for nice axis scale
  const totals = chartData.slice(1).map(row => row[1] + row[2]);
  const maxTotal = Math.max(...totals);

  const options = {
    title: 'Today Sale: Retail + WS',
    isStacked: true,
    legend: { position: 'top' },
    chartArea: {
      left: 60,
      right: 20,
      width: '100%'
    },
    colors: ['#22265C', '#00A651'],
    annotations: {
      alwaysOutside: true,
      textStyle: {
        fontSize: 12,
        color: '#000',
        auraColor: 'none'
      }
    },
    vAxis: {
      viewWindow: {
        max: maxTotal * 1.1
      },
      
      gridlines: { color: 'transparent' }
    },
    hAxis: {
      textPosition: 'out'
    }
  };

  const chart = new google.visualization.ColumnChart(document.getElementById('today_sales_chart'));
  chart.draw(dataTable, options);
}

function drawMonthSalesChart() {
  // âœ… Build data table: Branch | Month Sale | Annotation
  const chartData = [
    ['Branch', 'Month Sale', { role: 'annotation' }]
  ];

  globalReportData.forEach(row => {
    const branch = row['Branch'];
    const monthSale = Number(row['Month sale']) || 0;
    chartData.push([branch, monthSale, monthSale]);
  });

  const dataTable = google.visualization.arrayToDataTable(chartData);

  // âœ… Find max for axis scaling
  const totals = chartData.slice(1).map(row => row[1]);
  const maxTotal = Math.max(...totals);

  const options = {
    title: 'Month Sale',
    legend: 'none',
    chartArea: {
      left: 60,
      right: 20,
      width: '100%'
    },
    colors: ['#00A651'],
    annotations: {
      alwaysOutside: true,
      textStyle: {
        fontSize: 12,
        color: '#000',
        auraColor: 'none'
      }
    },
    vAxis: {
      viewWindow: {
        max: maxTotal * 1.1
      },
      gridlines: { color: 'transparent' }
    },
    hAxis: {
      textPosition: 'out'
    }
  };

  const chart = new google.visualization.ColumnChart(document.getElementById('month_sales_chart'));
  chart.draw(dataTable, options);
}


  // âœ… On page load: show dashboard by default
  window.onload = () => showTab('dashboard');

</script>

</body>
</html>
